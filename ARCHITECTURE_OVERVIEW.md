# ğŸ—ï¸ Tile-Based Edge SR ç³»ç»Ÿæ¶æ„

## ğŸ“ ç³»ç»Ÿæ•´ä½“æ¶æ„

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ  Tile-Based Edge Super-Resolution System                â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                 â–¼                 â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Input  â”‚       â”‚ GT Image â”‚      â”‚  Output  â”‚
   â”‚  LR    â”‚       â”‚(Optional)â”‚      â”‚   HR     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚                 â–²
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Main Processing     â”‚
              â”‚      Pipeline         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                 â–¼                 â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Pre-    â”‚      â”‚  Tile    â”‚     â”‚  Post-   â”‚
   â”‚ Process â”‚      â”‚Processingâ”‚     â”‚ Process  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ è¯¦ç»†å¤„ç†æµç¨‹

### Phase 1: é¢„å¤„ç†é˜¶æ®µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 1: Pre-processing                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¾“å…¥ LR å›¾ç‰‡ (ä»»æ„å°ºå¯¸)
    â”‚
    â”œâ”€ è¯»å–å›¾ç‰‡: read_image()
    â”‚   â””â”€ å½’ä¸€åŒ–åˆ° [-1, 1]
    â”‚
    â”œâ”€ è®¡ç®—ä¸Šé‡‡æ ·æ¯”ä¾‹
    â”‚   upsample_scale = max(input_size/min(H,W), upscale)
    â”‚   
    â”œâ”€ ä¸Šé‡‡æ · LR å›¾ç‰‡
    â”‚   F.interpolate(mode='bicubic')
    â”‚   åŸå§‹: 256x256 â†’ ä¸Šé‡‡æ ·: 2048x2048
    â”‚
    â”œâ”€ å¡«å……åˆ°32çš„å€æ•°
    â”‚   if not (H%32==0 and W%32==0):
    â”‚       pad to multiple of 32
    â”‚
    â””â”€ åŠ è½½ GT å›¾ç‰‡ (å¦‚æœæä¾›)
        read_image(gt_path)
        
Output: upsampled_lr, gt_image, original_size
```

### Phase 2: Tileåˆ‡åˆ†é˜¶æ®µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 2: Tile Splitting                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ£€æŸ¥å›¾ç‰‡å°ºå¯¸
    â”‚
    â”œâ”€ å¦‚æœ H > vqgantile_size or W > vqgantile_size
    â”‚   â”‚
    â”‚   â””â”€ åˆ›å»º ImageSpliterWithEdge
    â”‚       â”‚
    â”‚       â”œâ”€ å‚æ•°:
    â”‚       â”‚   - pch_size: 1280 (tileå°ºå¯¸)
    â”‚       â”‚   - stride: 1000 (tileæ­¥é•¿)
    â”‚       â”‚   - sf: 1 (ç¼©æ”¾å› å­)
    â”‚       â”‚   - gt_image: GTå›¾ç‰‡å¼ é‡
    â”‚       â”‚   - original_lr_size: åŸå§‹å°ºå¯¸
    â”‚       â”‚
    â”‚       â””â”€ è®¡ç®—tileå¸ƒå±€:
    â”‚           å›¾ç‰‡ 2048x2048
    â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           â”‚ Tile 1  â”‚ Tile 2  â”‚
    â”‚           â”‚1280x1280â”‚1280x1048â”‚
    â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚           â”‚ Tile 3  â”‚ Tile 4  â”‚
    â”‚           â”‚1048x1280â”‚1048x1048â”‚
    â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚           é‡å åŒºåŸŸ: 280åƒç´ 
    â”‚
    â””â”€ å¦åˆ™: æ•´å›¾å¤„ç†ï¼Œæ— éœ€tile

Output: tile_iterator or full_image
```

### Phase 3: Tileå¤„ç†å¾ªç¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 3: Tile Processing Loop                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¯¹æ¯ä¸ª tile:
    â”‚
    â”œâ”€ 3.1: æå– LR tile
    â”‚   lr_tile = im_lq[h_start:h_end, w_start:w_end]
    â”‚   å°ºå¯¸: 1280x1280 (æˆ–è¾¹ç•Œtileçš„å®é™…å°ºå¯¸)
    â”‚
    â”œâ”€ 3.2: è·å–å¯¹åº”çš„ Edge Map
    â”‚   â”‚
    â”‚   â”œâ”€ å¦‚æœæœ‰ GT å›¾ç‰‡:
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€ æå– GT tile
    â”‚   â”‚   â”‚   scale = H_gt / H_lr_upsampled
    â”‚   â”‚   â”‚   coords_gt = coords_lr * scale
    â”‚   â”‚   â”‚   gt_tile = gt_image[coords_gt]
    â”‚   â”‚   â”‚   resize if needed
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€ ä» GT tile ç”Ÿæˆ edge map
    â”‚   â”‚       Canny(gt_tile) â†’ edge_map
    â”‚   â”‚
    â”‚   â””â”€ å¦åˆ™: ä» LR tile ç”Ÿæˆ
    â”‚       Canny(lr_tile) â†’ edge_map
    â”‚
    â”œâ”€ 3.3: Encode åˆ° Latent ç©ºé—´
    â”‚   lr_tile (1280x1280)
    â”‚       â†“ VQGAN Encoder
    â”‚   latent (160x160)  # 8x downsampling
    â”‚
    â”œâ”€ 3.4: Diffusion é‡‡æ · (å¸¦edge guidance)
    â”‚   â”‚
    â”‚   â”œâ”€ è¾“å…¥:
    â”‚   â”‚   - latent: 160x160
    â”‚   â”‚   - edge_map: 1280x1280
    â”‚   â”‚   - semantic_c: text embedding
    â”‚   â”‚
    â”‚   â”œâ”€ ç¬¬äºŒå±‚ Tile å¤„ç† (åœ¨ latent ç©ºé—´)
    â”‚   â”‚   latent (160x160)
    â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   â”‚   â”‚ 64x64  â”‚ 64x64  â”‚ 64x64  â”‚
    â”‚   â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚   â”‚   â”‚ 64x64  â”‚ 64x64  â”‚ 64x64  â”‚
    â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚   â”‚   é‡å : 32åƒç´  (latentç©ºé—´)
    â”‚   â”‚
    â”‚   â””â”€ Diffusion æ­¥éª¤:
    â”‚       for t in timesteps (200 steps):
    â”‚           noise_pred = UNet(x_t, t, edge_map, semantic_c)
    â”‚           x_{t-1} = denoise(x_t, noise_pred)
    â”‚
    â”œâ”€ 3.5: Decode å›åƒç´ ç©ºé—´
    â”‚   latent (160x160)
    â”‚       â†“ VQGAN Decoder (with LR features)
    â”‚   hr_tile (1280x1280)
    â”‚
    â”œâ”€ 3.6: é¢œè‰²ä¿®æ­£ (å¯é€‰)
    â”‚   if colorfix_type == 'adain':
    â”‚       hr_tile = AdaIN(hr_tile, lr_tile)
    â”‚   elif colorfix_type == 'wavelet':
    â”‚       hr_tile = wavelet_reconstruction(hr_tile, lr_tile)
    â”‚
    â””â”€ 3.7: é«˜æ–¯æƒé‡ç´¯ç§¯
        spliter.update_gaussian(hr_tile, coords)
        
        ç´¯ç§¯çŸ©é˜µ:
        result[coords] += hr_tile * gaussian_weight
        count[coords] += gaussian_weight

å¾ªç¯ç»“æŸ
```

### Phase 4: åå¤„ç†é˜¶æ®µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 4: Post-processing                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”œâ”€ 4.1: èåˆæ‰€æœ‰ tiles
â”‚   final_result = spliter.gather()
â”‚   result = result / count  # å½’ä¸€åŒ–
â”‚   
â”œâ”€ 4.2: å»é™¤å¡«å……
â”‚   if flag_pad:
â”‚       result = result[:ori_h, :ori_w]
â”‚
â”œâ”€ 4.3: æœ€ç»ˆç¼©æ”¾ (å¦‚æœéœ€è¦)
â”‚   if upsample_scale > target_upscale:
â”‚       result = F.interpolate(result, target_size)
â”‚
â”œâ”€ 4.4: è½¬æ¢åˆ° [0, 255]
â”‚   result = (result + 1.0) / 2.0 * 255.0
â”‚
â””â”€ 4.5: ä¿å­˜ç»“æœ
    Image.save(output_path)
```

## ğŸ¯ å…³é”®ç»„ä»¶è¯¦è§£

### 1. ImageSpliterWithEdge ç±»

```python
class ImageSpliterWithEdge(ImageSpliterTh):
    """
    æ‰©å±•çš„å›¾ç‰‡åˆ†å‰²å™¨ï¼Œæ”¯æŒedge mapå¤„ç†
    
    ç»§æ‰¿è‡ª: ImageSpliterTh
    æ–°å¢åŠŸèƒ½: GT tileæå–å’Œedge mapç”Ÿæˆ
    """
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ImageSpliterWithEdge               â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  å±æ€§:                              â”‚
    â”‚  - im_ori: åŸå§‹å›¾ç‰‡                â”‚
    â”‚  - gt_image: GTå›¾ç‰‡                â”‚
    â”‚  - original_lr_size: åŸå§‹LRå°ºå¯¸    â”‚
    â”‚  - upsampled_lr_size: ä¸Šé‡‡æ ·å°ºå¯¸   â”‚
    â”‚  - im_res: ç´¯ç§¯ç»“æœ                â”‚
    â”‚  - pixel_count: åƒç´ è®¡æ•°           â”‚
    â”‚  - weight: é«˜æ–¯æƒé‡çŸ©é˜µ            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  æ–¹æ³•:                              â”‚
    â”‚  - __init__(): åˆå§‹åŒ–               â”‚
    â”‚  - __next__(): è·å–ä¸‹ä¸€ä¸ªtile      â”‚
    â”‚  - get_edge_map_for_current_tile() â”‚
    â”‚  - update_gaussian(): é«˜æ–¯æƒé‡æ›´æ–° â”‚
    â”‚  - gather(): æ”¶é›†æœ€ç»ˆç»“æœ          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Edge Map ç”Ÿæˆæµç¨‹

```
GT Tile (1280x1280, RGB)
    â”‚
    â”œâ”€ 1. è½¬æ¢åˆ°ç°åº¦
    â”‚   cv2.cvtColor(RGB2GRAY)
    â”‚   â†’ gray_image (1280x1280, å•é€šé“)
    â”‚
    â”œâ”€ 2. é«˜æ–¯æ¨¡ç³Š
    â”‚   cv2.GaussianBlur(kernel=5x5, sigma=1.4)
    â”‚   â†’ blurred_image
    â”‚
    â”œâ”€ 3. Cannyè¾¹ç¼˜æ£€æµ‹
    â”‚   cv2.Canny(threshold1=100, threshold2=200)
    â”‚   â†’ edges (1280x1280, äºŒå€¼å›¾)
    â”‚
    â”œâ”€ 4. è½¬æ¢ä¸º3é€šé“
    â”‚   cv2.cvtColor(GRAY2RGB)
    â”‚   â†’ edges_3ch (1280x1280x3)
    â”‚
    â””â”€ 5. å½’ä¸€åŒ–åˆ° [-1, 1]
        (edges_3ch / 127.5) - 1.0
        â†’ edge_map (1280x1280x3, [-1,1])

è¾“å‡º: edge_map tensor [1, 3, 1280, 1280]
```

### 3. é«˜æ–¯æƒé‡èåˆ

```
é«˜æ–¯æƒé‡ç”Ÿæˆ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  _gaussian_weights(w, h)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  var = 0.01                          â”‚
â”‚  for x in range(w):                  â”‚
â”‚      prob_x = exp(-(x-mid)Â²/var)     â”‚
â”‚  for y in range(h):                  â”‚
â”‚      prob_y = exp(-(y-mid)Â²/var)     â”‚
â”‚  weights = outer(prob_y, prob_x)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æƒé‡çŸ©é˜µå¯è§†åŒ– (1280x1280):
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  0.1â”‚ .  .  .  .  .  .  .  .  .  â”‚
  0.3â”‚ .  .  *  *  *  *  *  .  .  â”‚
  0.5â”‚ .  *  *  *  *  *  *  *  .  â”‚
  0.7â”‚ .  *  *  *  â–ˆ  â–ˆ  *  *  .  â”‚
  0.9â”‚ .  *  *  â–ˆ  â–ˆ  â–ˆ  â–ˆ  *  .  â”‚
  1.0â”‚ .  *  *  â–ˆ  â–ˆ  â–ˆ  â–ˆ  *  .  â”‚  â† ä¸­å¿ƒ
  0.9â”‚ .  *  *  â–ˆ  â–ˆ  â–ˆ  â–ˆ  *  .  â”‚
  0.7â”‚ .  *  *  *  â–ˆ  â–ˆ  *  *  .  â”‚
  0.5â”‚ .  *  *  *  *  *  *  *  .  â”‚
  0.3â”‚ .  .  *  *  *  *  *  .  .  â”‚
  0.1â”‚ .  .  .  .  .  .  .  .  .  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

èåˆå…¬å¼:
result[coords] = Î£(tile_i * weight_i) / Î£(weight_i)
```

## ğŸ”€ æ•°æ®æµå›¾

### å•ä¸ªTileçš„å®Œæ•´æ•°æ®æµ

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ GT Image â”‚
                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                 extract_tile_from_gt()
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â–¼              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LR Tile  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ Edge Map â”‚
â”‚1280x1280 â”‚      â”‚   GT Tile    â”‚       â”‚1280x1280 â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚  1280x1280   â”‚       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                   â”‚                    â”‚
     â”‚                   â–¼                    â”‚
     â”‚          generate_edge_map()           â”‚
     â”‚                   â”‚                    â”‚
     â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                            â”‚
     â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         VQGAN Encoder                   â”‚
â”‚  Input: 1280x1280x3                     â”‚
â”‚  Output: 160x160x4 (latent)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Latent (init)  â”‚
        â”‚   160x160x4    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”œâ”€â”€â”€â”€ Add noise â”€â”€â”€â”
                 â”‚                  â”‚
                 â–¼                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Noisy Latent  â”‚   â”‚  Edge    â”‚
        â”‚   160x160x4    â”‚   â”‚  Map     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                 â”‚                â”‚
                 â”‚                â”‚
                 â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Diffusion Sampling (200 steps)        â”‚
â”‚  - UNet prediction with edge guidance      â”‚
â”‚  - Tile-based processing (64x64 in latent) â”‚
â”‚  - Progressive denoising                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Clean Latent  â”‚
        â”‚   160x160x4    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         VQGAN Decoder                      â”‚
â”‚  Input: 160x160x4 (latent)                 â”‚
â”‚  Output: 1280x1280x3 (HR tile)             â”‚
â”‚  With: LR features for better detail       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    HR Tile     â”‚
        â”‚   1280x1280    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
          Color Correction
                 â”‚
                 â–¼
      Gaussian Weight Accumulation
                 â”‚
                 â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  Result  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’¾ å†…å­˜å ç”¨åˆ†æ

### å„é˜¶æ®µå†…å­˜å ç”¨

```
                 Memory Usage (GB)
                 0    4    8    12   16   20
Phase 1: Load   â”œâ”€â”€â”€â”€â”¤
Phase 2: Split  â”œâ”€â”€â”€â”€â”¤
Phase 3: Tile 1 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â† Peak
  - Encode      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
  - Diffusion   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â† Peak
  - Decode      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
Phase 3: Tile 2 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  ...
Phase 4: Merge  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
Phase 5: Save   â”œâ”€â”€â”€â”€â”¤

æ€»ç»“:
- åŸºç¡€å ç”¨: ~4GB (æ¨¡å‹)
- Tileå¤„ç†: +8-12GB (å–å†³äºtile_size)
- å³°å€¼: Diffusioné‡‡æ ·é˜¶æ®µ
```

### å‚æ•°å¯¹å†…å­˜çš„å½±å“

```
vqgantile_size = 768:
â”œâ”€ LR tile: 768x768x3 = ~1.7MB
â”œâ”€ Latent: 96x96x4 = ~0.14MB
â””â”€ å³°å€¼å†…å­˜: ~8GB

vqgantile_size = 1280:
â”œâ”€ LR tile: 1280x1280x3 = ~4.7MB
â”œâ”€ Latent: 160x160x4 = ~0.39MB
â””â”€ å³°å€¼å†…å­˜: ~16GB

vqgantile_size = 1536:
â”œâ”€ LR tile: 1536x1536x3 = ~6.8MB
â”œâ”€ Latent: 192x192x4 = ~0.56MB
â””â”€ å³°å€¼å†…å­˜: ~20GB
```

## âš™ï¸ æ¨¡å‹æ¶æ„

### å®Œæ•´æ¨¡å‹æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LatentDiffusionSRTextWTWithEdge                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Text Encoder (CLIP)                     â”‚   â”‚
â”‚  â”‚  - Input: text prompt                    â”‚   â”‚
â”‚  â”‚  - Output: semantic embedding            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  First Stage (VQGAN)                     â”‚   â”‚
â”‚  â”‚  â”œâ”€ Encoder: Image â†’ Latent              â”‚   â”‚
â”‚  â”‚  â”‚  - 8x downsampling                    â”‚   â”‚
â”‚  â”‚  â”‚  - 4 channels                         â”‚   â”‚
â”‚  â”‚  â””â”€ Decoder: Latent â†’ Image              â”‚   â”‚
â”‚  â”‚     - With LR feature fusion             â”‚   â”‚
â”‚  â”‚     - Residual connections               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  UNet (with Edge Processing)             â”‚   â”‚
â”‚  â”‚  â”œâ”€ Input channels: 4 (latent) + 3 (edge)â”‚   â”‚
â”‚  â”‚  â”œâ”€ Cross-attention with text            â”‚   â”‚
â”‚  â”‚  â”œâ”€ Self-attention layers                â”‚   â”‚
â”‚  â”‚  â”œâ”€ ResNet blocks                        â”‚   â”‚
â”‚  â”‚  â””â”€ Output: Noise prediction             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Edge Processor                          â”‚   â”‚
â”‚  â”‚  â”œâ”€ Edge encoding                        â”‚   â”‚
â”‚  â”‚  â”œâ”€ Feature extraction                   â”‚   â”‚
â”‚  â”‚  â””â”€ Fusion with latent                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ›ï¸ é…ç½®ç©ºé—´

### å¯è°ƒå‚æ•°åŠå…¶å½±å“

```
å‚æ•°ç»´åº¦:

1. Tileå°ºå¯¸ç»´åº¦
   vqgantile_size â”€â”¬â”€ 768  (å°) â†’ ä½å†…å­˜, æ›´å¤štile
                   â”œâ”€ 1024 (ä¸­) â†’ å¹³è¡¡
                   â”œâ”€ 1280 (å¤§) â†’ é«˜è´¨é‡, é«˜å†…å­˜
                   â””â”€ 1536 (è¶…å¤§) â†’ è¶…å¤§å›¾ç‰‡

2. é‡å ç»´åº¦
   vqgantile_stride â”€â”¬â”€ 1200 (å°é‡å ) â†’ å¿«, å¯èƒ½æœ‰æ¥ç¼
                     â”œâ”€ 1000 (ä¸­é‡å ) â†’ å¹³è¡¡
                     â””â”€ 800  (å¤§é‡å ) â†’ æ…¢, æ— æ¥ç¼

3. ç²¾ç»†åº¦ç»´åº¦
   tile_overlap â”€â”¬â”€ 16 (å°) â†’ å¿«
                 â”œâ”€ 32 (ä¸­) â†’ å¹³è¡¡
                 â””â”€ 48 (å¤§) â†’ é«˜è´¨é‡

4. è´¨é‡ç»´åº¦
   ddpm_steps â”€â”¬â”€ 100 (å¿«é€Ÿ)
               â”œâ”€ 200 (æ ‡å‡†)
               â””â”€ 300 (é«˜è´¨é‡)

5. é¢œè‰²ç»´åº¦
   colorfix_type â”€â”¬â”€ nofix (æ— )
                  â”œâ”€ wavelet (å¥½)
                  â””â”€ adain (æœ€å¥½)
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### ä¼˜åŒ–é‡‘å­—å¡”

```
                    æœ€é«˜è´¨é‡
                       â–²
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  tile_size=1280, stride=800 â”‚
        â”‚  overlap=48, steps=300      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  tile_size=1280, stride=1000â”‚  â† æ¨è
        â”‚  overlap=32, steps=200      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  tile_size=1024, stride=1000â”‚
        â”‚  overlap=16, steps=100      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                    æœ€å¿«é€Ÿåº¦
```

## ğŸ“Š å†³ç­–æ ‘

### å‚æ•°é€‰æ‹©å†³ç­–æµç¨‹

```
                  å¼€å§‹
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  æ˜¾å­˜å¤šå°‘ï¼Ÿ        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         â”‚         â”‚
        <12GB    12-16GB   >16GB
         â”‚         â”‚         â”‚
         â–¼         â–¼         â–¼
      size=768  size=1024 size=1280
         â”‚         â”‚         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  è¿½æ±‚ä»€ä¹ˆï¼Ÿ        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         â”‚         â”‚
        é€Ÿåº¦      å¹³è¡¡      è´¨é‡
         â”‚         â”‚         â”‚
         â–¼         â–¼         â–¼
    steps=100 steps=200 steps=300
    strideâ†‘  stride=1k strideâ†“
    overlapâ†“ overlap=32 overlapâ†‘
         â”‚         â”‚         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                 è¿è¡Œï¼
```

---

## ğŸ”— å¿«é€Ÿé“¾æ¥

- **å…¥é—¨**: [TILE_EDGE_README.md](TILE_EDGE_README.md)
- **å¯¹æ¯”**: [TILE_VS_STANDARD_COMPARISON.md](TILE_VS_STANDARD_COMPARISON.md)
- **æŠ€æœ¯**: [TILE_EDGE_PROCESSING_GUIDE.md](TILE_EDGE_PROCESSING_GUIDE.md)
- **GTå‰ªåˆ‡**: [GT_TILE_EXTRACTION_VISUAL_GUIDE.md](GT_TILE_EXTRACTION_VISUAL_GUIDE.md)
- **ç¤ºä¾‹**: [example_tile_edge_processing.sh](example_tile_edge_processing.sh)

---

**ç‰ˆæœ¬**: 1.0  
**æ—¥æœŸ**: 2025-10-08  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

