# 对比拼接图生成功能

## 功能说明

在每个checkpoint的全部推理模式完成后，系统会自动生成对比拼接图，将以下6张图片拼接成一张大图并添加标签：

1. **GT (Ground Truth)** - 原始高清图片
2. **StableSR** - StableSR基线模型推理结果
3. **Edge** - 使用真实边缘的推理结果
4. **No Edge** - 使用黑色边缘的推理结果
5. **Dummy Edge** - 使用固定dummy edge的推理结果
6. **Edge Map** - Edge模式推理时的边缘图

## 拼接布局

对比图采用标题栏 + 2×3 网格布局：

```
┌────────────────────────────────────────────────────────────┐
│  实验名称 | Epoch编号 | 图片名称 | 生成时间              │
├────────────────────────────────────────────────────────────┤
│  GT原图     │  (10px)  │  StableSR   │  (10px)  │   Edge  │
│  [标签80px] │          │ [标签80px]  │          │[标签80] │
│  [图512²]   │          │ [图512²]    │          │[图512²] │
├─────────────┴──────────┴─────────────┴──────────┴─────────┤
│                    10px 纵向间距                           │
├─────────────┬──────────┬─────────────┬──────────┬─────────┤
│  No Edge    │  (10px)  │ Dummy Edge  │  (10px)  │Edge Map │
│  [标签80px] │          │ [标签80px]  │          │[标签80] │
│  [图512²]   │          │ [图512²]    │          │[图512²] │
└─────────────┴──────────┴─────────────┴──────────┴─────────┘
```

- 标题栏显示实验关键信息
- 每张图片上方有固定80px标签，显示模式和指标
- 图片之间有10px间距，视觉更清晰

## 自动生成时机

对比拼接图会在以下情况自动生成：

### 模式1：推理全部checkpoints
- 在所有选定的checkpoint完成edge、no_edge、dummy_edge三种模式推理后
- 自动为每个epoch生成对比拼接图

### 模式2：推理指定checkpoint
- 在指定checkpoint的三种模式全部成功完成后
- 自动生成该checkpoint的对比拼接图

## 输出位置

对比拼接图保存在：
```
<输出目录>/<实验名称>/comparisons/epochs_<epoch号>/
```

例如：
```
validation_results/stablesr_edge_loss_20251015_194003/comparisons/epochs_749/
```

每张对比图的文件名格式：
```
<原图名>_comparison.png
```

例如：`0803_comparison.png`

## 手动生成

如果需要手动为特定epoch生成对比拼接图，可以直接运行：

```bash
python scripts/create_comparison_grid.py \
    <结果基础路径> \
    <GT图片目录> \
    <epoch号>
```

示例：
```bash
python scripts/create_comparison_grid.py \
    validation_results/stablesr_edge_loss_20251015_194003 \
    /mnt/nas_dp/test_dataset/512x512_valid_HR \
    749
```

## 依赖库

脚本使用以下Python库（通常已预装）：
- PIL (Pillow) - 图像处理
- numpy - 数值计算

## 对比图示例尺寸

- **完整对比图**: 1556×1254 像素
  - 标题栏（新增）: 60 像素
  - 图片网格区域: 1556×1194 像素
- **单张子图**: 512×592 像素
  - 标签区域（固定）: 80 像素
  - 图片区域（保持原始尺寸）: 512×512 像素
- **布局**: 标题栏 + 2行×3列图片网格
- **图片间距**: 横向10px，纵向10px

## 设计特点

### 标题栏（新增）
- **固定高度**: 60像素
- **位置**: 对比图最顶部
- **背景色**: 白色，与下方网格区域有分隔线
- **内容**:
  - 第1行: 实验名称（粗体，20px）
    - 显示完整的实验目录名称
  - 第2行: 详细信息（14px）
    - Epoch编号
    - 当前图片名称
    - 对比图生成时间（精确到秒）

### 标签区域
- **固定高度**: 80像素（所有图片统一）
- **位置**: 图片上方
- **内容**:
  - 第1行: 模式名称（粗体，22px）
  - 第2-3行: 完整指标（13px）
    - PSNR（峰值信噪比）
    - SSIM（结构相似度）
    - LPIPS（感知损失）
    - Edge PSNR（边缘峰值信噪比）
    - Edge Overlap（边缘重叠率）

### 图片区域
- **尺寸保持**: 512×512像素（完全不改变原始图片）
- **位置**: 标签下方
- **分隔**: 与标签区域有2px灰色分隔线

### 间距设计
- **横向间距**: 10像素（各列之间）
- **纵向间距**: 10像素（两行之间）
- **背景色**: 浅灰色(240, 240, 240)，便于区分各图片

## 注意事项

1. 只有当所有6种图片都存在时，才会生成对比拼接图
2. 如果对比图已存在，会自动跳过生成
3. 每张对比图的质量设置为95%，确保高清晰度
4. 图片标签使用DejaVu Sans Bold字体，如果系统中没有该字体，会使用默认字体
5. 脚本会自动适配StableSR的两种可能路径结构：`stablesr/epochs_baseline/` 或 `stablesr/baseline/`
6. 标签区域固定高度确保所有子图对齐整齐

## 功能优势

- **全自动**：推理完成后无需手动操作
- **清晰对比**：6种结果一目了然
- **便于分析**：快速识别不同模式的效果差异
- **节省时间**：无需手动打开多个文件进行比较

