# run_auto_inference.sh 完整功能说明

## 📅 版本：v3.0 - 2025-10-16

---

## 🎯 选项1：推理指定目录下全部 checkpoint

完整的交互式推理控制系统，包含5个用户选择点。

---

## 🎨 完整交互流程

```bash
./run_auto_inference.sh

==================================================
1. 推理指定目录下全部 checkpoint (edge & no-edge)
==================================================

[步骤1] 选择 logs 目录
请输入 logs 目录路径 [logs]: ← 回车

[步骤2] 选择实验目录
可用的子目录：
1. stablesr_edge_loss_20251015_194003
请选择目录编号: 1

[步骤3] 设置输出目录
请输入保存目录名 [validation_results]: ← 回车

[选择1] 是否重新计算指标？
是否重新计算已有结果的指标（Edge PSNR等）？
  注意：新推理的结果会自动计算所有指标
  此选项仅针对跳过的已有结果

重新计算指标? (y/n) [默认: n]: ← 回车

[选择2] 每次最多计算多少个？⭐ 新增
设置每次最多计算多少个 checkpoint：
  -1: 全部计算（默认）
  N: 每次最多计算 N 个

每次最多计算 checkpoint 数量 [默认: -1]: ← 回车

[预扫描] 统计需要推理的任务
正在检查哪些 checkpoint 需要推理...

推理需求统计：
  EDGE 模式: 需要推理 2 个 checkpoint
    └─ Epochs: 000138 000166
  NO-EDGE 模式: 需要推理 2 个 checkpoint
    └─ Epochs: 000138 000166
  DUMMY-EDGE 模式: 需要推理 2 个 checkpoint
    └─ Epochs: 000138 000166
  总计: 需要推理 6 个任务

[选择3] 确认开始推理？
⚠️  发现 6 个新的推理任务需要执行

是否开始推理? (y/n) [默认: y]: ← 回车

[执行] 推理过程
✓ 开始执行推理...

正在运行 EDGE 模式推理...
→ 处理 epoch=000138
→ 处理 epoch=000166
...

[结果] 生成报告
正在生成推理结果报告...
✓ 报告生成成功
```

**总计：5个选择点（3个是可选的）**

---

## 📋 5个选择点详解

### 选择1：重新计算指标（可选）

```bash
重新计算指标? (y/n) [默认: n]:
```

| 选择 | 效果 | 适用场景 |
|-----|------|---------|
| **n (默认)** | 快速模式，只计算新推理 | 日常使用 |
| **y** | 完整模式，检查并补充所有 | 数据整理 |

### 选择2：批次大小限制（可选）⭐ 新增

```bash
每次最多计算 checkpoint 数量 [默认: -1]:
```

| 输入 | 效果 | 适用场景 |
|-----|------|---------|
| **-1 (默认)** | 全部处理 | 时间充足 |
| **1** | 每次1个 | 快速测试 |
| **2-3** | 每次2-3个 | 有限时间 |
| **5-10** | 每次5-10个 | 分批处理 |

### 选择3：开始推理（必选）

```bash
是否开始推理? (y/n) [默认: y]:
```

| 选择 | 效果 | 适用场景 |
|-----|------|---------|
| **y (默认)** | 开始推理 | 确认无误 |
| **n** | 取消返回 | 任务太多或时间不对 |

---

## 🎯 常用组合

### 组合A：快速模式（最常用）

```bash
重新计算? [n]: ← 回车
批次限制 [-1]: ← 回车
开始推理? [y]: ← 回车
```

**特点**：3次回车，全自动

### 组合B：分批处理

```bash
重新计算? [n]: ← 回车
批次限制 [-1]: 2 ← 设置限制
开始推理? [y]: ← 回车
```

**特点**：每次处理2个，可多次运行

### 组合C：完整模式

```bash
重新计算? [n]: y ← 确保完整
批次限制 [-1]: ← 回车
开始推理? [y]: ← 回车
```

**特点**：确保所有数据完整

### 组合D：测试模式

```bash
重新计算? [n]: ← 回车
批次限制 [-1]: 1 ← 只处理1个
开始推理? [y]: ← 回车
```

**特点**：快速验证

---

## 📊 功能矩阵

| 功能 | 作用 | 默认 | 可选 |
|-----|------|------|------|
| 目录选择 | 选择实验 | - | 必选 |
| 输出设置 | 设置保存路径 | validation_results | 必选 |
| **重新计算指标** | 补充旧数据 | n（快速） | 可选 |
| **批次限制** | 控制数量 | -1（全部） | 可选 ⭐ |
| **推理确认** | 确认执行 | y（执行） | 必选 |
| 预扫描 | 显示统计 | 自动 | - |
| 列出 checkpoint | 显示名称 | 自动 | - |
| 智能跳过 | 跳过已有 | 自动 | - |
| 批量检查 | 确保完整 | 条件 | - |
| 生成报告 | CSV 报告 | 自动 | - |

---

## 💡 使用建议

### 首次推理

```bash
# 全自动（3次回车）
重新计算? [n]: ← 回车
批次限制 [-1]: ← 回车
开始推理? [y]: ← 回车
```

### 有很多新 checkpoint

```bash
# 分批处理（避免太长时间）
批次限制 [-1]: 3

# 第一批完成后，再运行继续
```

### 补充旧数据

```bash
# 确保完整
重新计算? [n]: y
批次限制 [-1]: ← 回车
```

### 快速测试

```bash
# 只处理1个
批次限制 [-1]: 1
```

---

## 📈 实际效果示例

### 场景：有5个新 checkpoint，限制为2

```bash
第一次运行：
  设置限制: 2
  
  EDGE 模式: 处理 2 个 (epoch 27, 55)
  NO-EDGE 模式: 处理 2 个
  DUMMY-EDGE 模式: 处理 2 个
  
  统计: 已处理 6 个任务，剩余 9 个
  提示: ⚠ 还有 9 个任务未完成，请再次运行

第二次运行：
  设置限制: 2
  
  EDGE 模式:
    - 跳过 epoch 27（已有）
    - 跳过 epoch 55（已有）
    - 处理 epoch 83
    - 处理 epoch 111
  
  统计: 已处理 6 个任务，剩余 3 个

第三次运行：
  设置限制: 2
  
  EDGE 模式:
    - 跳过前面已有的
    - 处理 epoch 138
  
  统计: 已处理 3 个任务，剩余 0 个
  ✓ 全部完成
```

---

## ⚙️ 技术细节

### 限制检查位置

在三个推理循环（EDGE, NO-EDGE, DUMMY-EDGE）的开始处：

```bash
for CKPT_FILE in ...; do
    # 检查是否达到限制
    if [ "$MAX_CKPTS_PER_RUN" -ne -1 ] && [ "$PROCESSED" -ge "$MAX_CKPTS_PER_RUN" ]; then
        echo "✓ 已达到处理限制，停止推理"
        break
    fi
    
    # 处理 checkpoint
    ...
done
```

### 统计显示

```bash
if [ "$MAX_CKPTS_PER_RUN" -ne -1 ]; then
    if [ $REMAINING -gt 0 ]; then
        echo "  ⚠ 注意：还有 $REMAINING 个任务未完成"
        echo "     请再次运行脚本继续处理"
    fi
fi
```

---

## ✅ 完整功能总结

### 自动化功能
- [x] 5个指标自动计算
- [x] 智能跳过已有结果
- [x] CSV 报告自动生成
- [x] Epoch 自动排序

### 交互控制
- [x] 可选重新计算指标
- [x] **批次大小限制** ⭐ 新增
- [x] 推理前确认
- [x] 列出具体 checkpoint

### 智能检查
- [x] 预扫描统计
- [x] 检查所有必需指标
- [x] 批量扫描（可选）
- [x] 剩余任务提示

---

**🎊 功能已完整，用户体验优秀，推理流程完全可控！** 🚀

---

**快速使用**：
```bash
conda activate sr_infer
./run_auto_inference.sh
# 5次回车，完成！
```

