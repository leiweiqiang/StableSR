# StableSR Edge Map æ¨ç†æµ‹è¯•è„šæœ¬æ€»ç»“

## ğŸ“ åˆ›å»ºçš„æ–‡ä»¶

### 1. ä¸»è¦æµ‹è¯•è„šæœ¬

| æ–‡ä»¶å | åŠŸèƒ½ | ä½¿ç”¨åœºæ™¯ |
|--------|------|----------|
| `test_edge_inference.py` | å®Œæ•´çš„æ¨ç†æµ‹è¯•è„šæœ¬ | ç”Ÿäº§ç¯å¢ƒæµ‹è¯•ã€è¯¦ç»†åˆ†æ |
| `quick_edge_test.py` | å¿«é€Ÿæµ‹è¯•è„šæœ¬ | å¿«é€ŸéªŒè¯ã€å¼€å‘è°ƒè¯• |
| `example_edge_inference.py` | ç®€å•ç¤ºä¾‹ä»£ç  | å­¦ä¹ å‚è€ƒã€ä»£ç ç†è§£ |

### 2. å¯åŠ¨è„šæœ¬

| æ–‡ä»¶å | åŠŸèƒ½ | ä½¿ç”¨åœºæ™¯ |
|--------|------|----------|
| `run_edge_inference_test.sh` | å‘½ä»¤è¡Œå¯åŠ¨è„šæœ¬ | ä¾¿æ·å¯åŠ¨ã€æ‰¹é‡æµ‹è¯• |

### 3. æ–‡æ¡£

| æ–‡ä»¶å | åŠŸèƒ½ | ä½¿ç”¨åœºæ™¯ |
|--------|------|----------|
| `EDGE_INFERENCE_TEST_README.md` | è¯¦ç»†ä½¿ç”¨è¯´æ˜ | ç”¨æˆ·æŒ‡å—ã€å‚æ•°è¯´æ˜ |
| `INFERENCE_WITH_EDGE_MAP_GUIDE.md` | æ¨ç†æŒ‡å— | æŠ€æœ¯æ–‡æ¡£ã€å®ç°ç»†èŠ‚ |
| `EDGE_INFERENCE_SCRIPTS_SUMMARY.md` | æœ¬æ€»ç»“æ–‡æ¡£ | é¡¹ç›®æ¦‚è§ˆã€æ–‡ä»¶è¯´æ˜ |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼

```bash
# å¿«é€Ÿæµ‹è¯•ï¼ˆä½¿ç”¨åˆæˆå›¾åƒï¼‰
python quick_edge_test.py
```

### 2. ä½¿ç”¨å¯åŠ¨è„šæœ¬

```bash
# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x run_edge_inference_test.sh

# å¿«é€Ÿæµ‹è¯•
./run_edge_inference_test.sh quick

# æµ‹è¯•çœŸå®å›¾åƒ
./run_edge_inference_test.sh test input_image.jpg

# å¯¹æ¯”æµ‹è¯•
./run_edge_inference_test.sh compare input_image.jpg
```

### 3. å®Œæ•´æµ‹è¯•

```bash
# åŸºæœ¬æ¨ç†
python test_edge_inference.py \
    --config configs/stableSRNew/v2-finetune_text_T_512_edge.yaml \
    --ckpt /path/to/edge_model.ckpt \
    --input input_image.jpg \
    --steps 20 \
    --output inference_output
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. Edge Mapç”Ÿæˆ
- âœ… ä½¿ç”¨Cannyè¾¹ç¼˜æ£€æµ‹
- âœ… é«˜æ–¯æ¨¡ç³Šé¢„å¤„ç†ï¼ˆ5Ã—5, Ïƒ=1.4ï¼‰
- âœ… è‡ªé€‚åº”é˜ˆå€¼ï¼ˆ100, 200ï¼‰
- âœ… 3é€šé“RGBè¾“å‡ºï¼Œå€¼èŒƒå›´[-1, 1]

### 2. æ¨¡å‹æ¨ç†
- âœ… æ”¯æŒEdgeæ¨¡å‹åŠ è½½å’ŒéªŒè¯
- âœ… è‡ªåŠ¨å¤„ç†struct_condå’Œedge_map
- âœ… ä½¿ç”¨EdgeDDIMSamplerè¿›è¡Œé‡‡æ ·
- âœ… æ”¯æŒä¸åŒçš„DDPMæ­¥æ•°

### 3. ç»“æœä¿å­˜
- âœ… ä¿å­˜è¾“å…¥å›¾åƒã€edge mapã€æœ€ç»ˆç»“æœ
- âœ… æ”¯æŒå¯¹æ¯”æµ‹è¯•ï¼ˆä½¿ç”¨/ä¸ä½¿ç”¨edgeæ£€æµ‹ï¼‰
- âœ… è‡ªåŠ¨åˆ›å»ºè¾“å‡ºç›®å½•
- âœ… å¤šç§è¾“å‡ºæ ¼å¼æ”¯æŒ

### 4. æ€§èƒ½ä¼˜åŒ–
- âœ… GPUå†…å­˜ç®¡ç†
- âœ… æ‰¹å¤„ç†æ”¯æŒ
- âœ… ä¸­é—´ç»“æœæ¸…ç†
- âœ… å¯é…ç½®çš„é‡‡æ ·æ­¥æ•°

## ğŸ“Š æµ‹è¯•åœºæ™¯

### 1. åˆæˆå›¾åƒæµ‹è¯•
```bash
# ä½¿ç”¨å‡ ä½•å½¢çŠ¶åˆ›å»ºæµ‹è¯•å›¾åƒ
python quick_edge_test.py
```

### 2. çœŸå®å›¾åƒæµ‹è¯•
```bash
# æµ‹è¯•å•å¼ å›¾åƒ
python test_edge_inference.py --input real_image.jpg
```

### 3. å¯¹æ¯”æµ‹è¯•
```bash
# å¯¹æ¯”ä½¿ç”¨/ä¸ä½¿ç”¨edgeæ£€æµ‹çš„æ•ˆæœ
python test_edge_inference.py --input real_image.jpg --compare
```

### 4. æ‰¹é‡æµ‹è¯•
```bash
# æ‰¹é‡å¤„ç†å¤šå¼ å›¾åƒ
for img in images/*.jpg; do
    python test_edge_inference.py --input "$img" --output "results/$(basename "$img")"
done
```

## âš™ï¸ é…ç½®è¦æ±‚

### 1. å¿…éœ€æ–‡ä»¶
- âœ… Edgeæ¨¡å‹é…ç½®æ–‡ä»¶ï¼š`configs/stableSRNew/v2-finetune_text_T_512_edge.yaml`
- âœ… Edgeæ¨¡å‹æ£€æŸ¥ç‚¹ï¼šæ”¯æŒedgeå¤„ç†çš„.ckptæ–‡ä»¶
- âœ… è¾“å…¥å›¾åƒï¼šå¸¸è§æ ¼å¼ï¼ˆJPG, PNG, BMPç­‰ï¼‰

### 2. ç¯å¢ƒä¾èµ–
```bash
pip install torch torchvision
pip install opencv-python pillow numpy
pip install omegaconf pytorch-lightning
```

### 3. ç¡¬ä»¶è¦æ±‚
- GPU: æ¨èNVIDIA GPUï¼Œè‡³å°‘8GBæ˜¾å­˜
- å†…å­˜: è‡³å°‘16GB RAM
- å­˜å‚¨: è¶³å¤Ÿçš„ç©ºé—´ä¿å­˜ç»“æœ

## ğŸ¯ ä½¿ç”¨å»ºè®®

### 1. å¼€å‘è°ƒè¯•
- ä½¿ç”¨ `quick_edge_test.py` å¿«é€ŸéªŒè¯
- ä½¿ç”¨è¾ƒå°‘çš„DDPMæ­¥æ•°ï¼ˆ10-20æ­¥ï¼‰
- ä½¿ç”¨è¾ƒå°çš„è¾“å…¥å›¾åƒ

### 2. ç”Ÿäº§æµ‹è¯•
- ä½¿ç”¨ `test_edge_inference.py` å®Œæ•´æµ‹è¯•
- ä½¿ç”¨é€‚å½“çš„DDPMæ­¥æ•°ï¼ˆ20-50æ­¥ï¼‰
- ä½¿ç”¨å¯¹æ¯”æµ‹è¯•éªŒè¯æ•ˆæœ

### 3. æ€§èƒ½ä¼˜åŒ–
- æ ¹æ®GPUå†…å­˜è°ƒæ•´æ‰¹å¤§å°
- ä½¿ç”¨ `torch.no_grad()` è¿›è¡Œæ¨ç†
- åŠæ—¶æ¸…ç†ä¸­é—´å˜é‡

## ğŸ” æ•…éšœæ’é™¤

### 1. å¸¸è§é”™è¯¯
- **æ¨¡å‹åŠ è½½å¤±è´¥**: æ£€æŸ¥é…ç½®æ–‡ä»¶å’Œæ£€æŸ¥ç‚¹è·¯å¾„
- **CUDAå†…å­˜ä¸è¶³**: å‡å°‘DDPMæ­¥æ•°æˆ–è¾“å…¥å›¾åƒå¤§å°
- **Edgeæ£€æµ‹æ•ˆæœä¸æ˜æ˜¾**: æ£€æŸ¥è¾“å…¥å›¾åƒæ˜¯å¦åŒ…å«æ¸…æ™°è¾¹ç¼˜

### 2. è°ƒè¯•æŠ€å·§
- ä½¿ç”¨ `--compare` å‚æ•°å¯¹æ¯”æ•ˆæœ
- ä¿å­˜ä¸­é—´ç»“æœè¿›è¡Œåˆ†æ
- æ£€æŸ¥edge mapè´¨é‡

### 3. æ€§èƒ½ç›‘æ§
- ç›‘æ§GPUå†…å­˜ä½¿ç”¨
- è®°å½•æ¨ç†æ—¶é—´
- æ¯”è¾ƒä¸åŒå‚æ•°çš„æ•ˆæœ

## ğŸ“ˆ æ‰©å±•åŠŸèƒ½

### 1. è‡ªå®šä¹‰Edgeæ£€æµ‹
```python
# ä¿®æ”¹Cannyå‚æ•°
edges = cv2.Canny(img_blurred, threshold1=50, threshold2=150)
```

### 2. å¤šç§Edgeæ£€æµ‹æ–¹æ³•
```python
# å¯ä»¥ä½¿ç”¨Sobelã€Laplacianç­‰å…¶ä»–è¾¹ç¼˜æ£€æµ‹æ–¹æ³•
sobel_x = cv2.Sobel(gray, cv2.CV_64F, 1, 0, ksize=3)
```

### 3. æ‰¹é‡å¤„ç†
```python
# æ”¯æŒæ‰¹é‡å¤„ç†å¤šå¼ å›¾åƒ
for image_path in image_list:
    result = inference_with_edge(image_path)
```

## ğŸ“ æ€»ç»“

è¿™å¥—Edge Mapæ¨ç†æµ‹è¯•è„šæœ¬æä¾›äº†ï¼š

1. **å®Œæ•´çš„æµ‹è¯•æµç¨‹**: ä»æ¨¡å‹åŠ è½½åˆ°ç»“æœä¿å­˜
2. **å¤šç§ä½¿ç”¨æ–¹å¼**: å‘½ä»¤è¡Œã€è„šæœ¬ã€ç¤ºä¾‹ä»£ç 
3. **çµæ´»çš„å‚æ•°é…ç½®**: æ”¯æŒå„ç§æ¨ç†å‚æ•°è°ƒæ•´
4. **è¯¦ç»†çš„æ–‡æ¡£è¯´æ˜**: åŒ…å«ä½¿ç”¨æŒ‡å—å’ŒæŠ€æœ¯æ–‡æ¡£
5. **é”™è¯¯å¤„ç†æœºåˆ¶**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ•…éšœæ’é™¤

é€šè¿‡è¿™äº›è„šæœ¬ï¼Œç”¨æˆ·å¯ä»¥ï¼š
- å¿«é€ŸéªŒè¯Edgeæ¨¡å‹çš„åŠŸèƒ½
- å¯¹æ¯”Edgeæ£€æµ‹çš„æ•ˆæœ
- è°ƒè¯•å’Œä¼˜åŒ–æ¨ç†å‚æ•°
- è¿›è¡Œæ‰¹é‡å›¾åƒå¤„ç†

æ‰€æœ‰è„šæœ¬éƒ½ç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œç¡®ä¿æ˜“ç”¨æ€§å’Œå¯é æ€§ï¼Œæ˜¯ä½¿ç”¨StableSR Edgeæ¨¡å‹è¿›è¡Œæ¨ç†çš„ç†æƒ³å·¥å…·ã€‚
